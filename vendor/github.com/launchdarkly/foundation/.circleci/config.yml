version: 2

# Keep this at the top to reduce noise in chatrooms when we mess up circleci setup
experimental:
  notify:
    branches:
      only:
        - master

jobs:
  go-test:
    working_directory: /go/src/github.com/launchdarkly/foundation
    docker:
      - image: 554582317989.dkr.ecr.us-east-1.amazonaws.com/integration-testing/go-circleci:1.8.3-latest
      - image: redis:3.2.5
      - image: nats
      - image: mongo:3.4.3
    steps:
      - checkout
      - run: go-enforce

      - run:
          name: Wait for services to be ready
          command: dockerize -wait tcp://localhost:6379 -timeout 1m  # redis
          command: dockerize -wait http://localhost:8222 -timeout 1m  # gnatsd monitoring port

      - run: go-test

      - store_artifacts:
          path: /tmp/circle_reports

      - store_test_results:
          path: /tmp/circle_reports/go-test

workflows:
  version: 2
  test:
    jobs:
      - go-test
